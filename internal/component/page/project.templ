package page

import "github.com/solsteace/misite/internal/entity"
import "fmt"
import "github.com/solsteace/misite/internal/utility/api"
import "net/url"
import "strings"

const projectHtmlId = "main-project"

templ Project(project entity.Project) {
    <div class="lyt__1x2 lyt__1x2--1-3 specification">
        <div class="specification__extras">
            <div class="specification__extra">
                <b class="u__h--6"> Etc. </b> 
                <p> {project.DisplayTime()} </p>
            </div>

            if len(project.Link) > 0 {
                <div class="specification__extra">
                    <b class="u__h--6"> Links </b>
                    for _, l := range project.Link {
                        <a href={l.Url}> {l.DisplayText} </a>
                    }
                </div>
            }

            <div class="cmp__sticky">
                <div class="cmp__sticky-elem specification__extra specification__outline">
                    <b class="u__h--6"> Outline </b>
                    <nav id={fmt.Sprintf("outline-%s", projectHtmlId)} > </nav>
                </div>
            </div>
        </div>

        <article id={projectHtmlId} class="specification__content">
            <header class="specification__content-header">
                <h1> {project.Name} </h1>
                <p> {project.Synopsis} </p>

                <ul class="cmp__badge-list tag-badge-list">
                    if project.Serie != nil {
                        <li> 
                            <a
                                class="tag-badge-list__tag tag-badge-list__tag--special"
                                href={fmt.Sprintf("/serie/%d", project.Serie.Id)}
                                hx-get={fmt.Sprintf("/serie/%d", project.Serie.Id)}
                                hx-trigger="click"
                                hx-target="#page"
                                hx-push-url="true"
                                hx-replace-url="true"
                                hx-swap="innerHTML"
                            > {project.Serie.Name} </a>
                        </li>
                    }

                    for _, t := range project.Tag {
                        <li> 
                            <a
                                class="tag-badge-list__tag"
                                href= {fmt.Sprintf("%s?search=%s", 
                                    api.ExploreProjectUrl, url.QueryEscape(
                                        fmt.Sprintf("tag:%s", strings.ReplaceAll(t.Name, " ", "_"))))} 
                                hx-get= {fmt.Sprintf("%s?search=%s", 
                                    api.ExploreProjectUrl, url.QueryEscape(
                                        fmt.Sprintf("tag:%s", strings.ReplaceAll(t.Name, " ", "_"))))} 
                                hx-trigger="click consume"
                                hx-target="#page"
                                hx-push-url="true"
                            > {t.Name} </a> 
                        </li>
                    }
                </ul>
            </header>

            <div class="specification__content-body">
                @templ.Raw(project.Description)
            </div>
        </article>

        @templ.JSUnsafeFuncCall(
            fmt.Sprintf(
                "window._utilMakeOutline('%s', '%s')", 
                projectHtmlId, 
                fmt.Sprintf("outline-%s", projectHtmlId)))
        <script> 
            window.scroll({ top: 0, left: 0, behavior: "smooth" })
            window._utilHighlightCode() 
        </script>
    </div>
}